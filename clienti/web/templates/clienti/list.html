{% extends "base.html" %}

{% block title %}Clienti - Clienti CRM{% endblock %}

{% block content %}
<h1>üë• Gestione Clienti</h1>

<!-- Filtri e ricerca -->
<div class="grid">
    <div>
        <form method="get">
            <fieldset role="group">
                <input type="search" name="search" placeholder="Cerca cliente..." value="{{ search }}" />
                <select name="stato">
                    <option value="tutti" {% if stato == 'tutti' %}selected{% endif %}>Tutti gli stati</option>
                    <option value="attivo" {% if stato == 'attivo' %}selected{% endif %}>Attivi</option>
                    <option value="prospect" {% if stato == 'prospect' %}selected{% endif %}>Prospect</option>
                    <option value="pausa" {% if stato == 'pausa' %}selected{% endif %}>In pausa</option>
                    <option value="archiviato" {% if stato == 'archiviato' %}selected{% endif %}>Archiviati</option>
                </select>
                <button type="submit">üîç</button>
            </fieldset>
        </form>
    </div>
    <div>
        <p><strong>{{ clienti|length }} clienti</strong> trovati</p>
    </div>
</div>

<!-- Lista clienti -->
{% if clienti %}
<div class="table-responsive">
    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>Stato</th>
                <th>P.IVA</th>
                <th>Citt√†</th>
                <th>Tariffa/h</th>
                <th>Tags</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody>
        {% for cliente in clienti %}
        <tr>
            <td>
                <strong><a href="/clienti/{{ cliente.id }}">{{ cliente.nome }}</a></strong>
            </td>
            <td>
                {% if cliente.stato == 'attivo' %}
                    <span style="color: #28a745;">üü¢ Attivo</span>
                {% elif cliente.stato == 'prospect' %}
                    <span style="color: #ffc107;">üü° Prospect</span>
                {% elif cliente.stato == 'pausa' %}
                    <span style="color: #6c757d;">‚è∏Ô∏è Pausa</span>
                {% elif cliente.stato == 'archiviato' %}
                    <span style="color: #dc3545;">üì¶ Archiviato</span>
                {% else %}
                    {{ cliente.stato }}
                {% endif %}
            </td>
            <td>
                <small>{{ cliente.piva or '-' }}</small>
            </td>
            <td>
                <small>{{ cliente.citta or '-' }}</small>
            </td>
            <td>
                ‚Ç¨{{ cliente.tariffa_oraria|int }}/h
            </td>
            <td>
                {% if cliente.tags_list %}
                    {% for tag in cliente.tags_list[:2] %}
                        <small class="tag">{{ tag }}</small>
                    {% endfor %}
                    {% if cliente.tags_list|length > 2 %}
                        <small>+{{ cliente.tags_list|length - 2 }}</small>
                    {% endif %}
                {% else %}
                    <small>-</small>
                {% endif %}
            </td>
            <td>
                <div class="button-group-compact">
                    <a href="/clienti/{{ cliente.id }}" class="btn-icon btn-info" title="Visualizza dettagli">
                        üëÅÔ∏è
                    </a>
                    
                    <button type="button" class="btn-icon btn-primary edit-btn" title="Modifica cliente"
                            data-id="{{ cliente.id }}"
                            data-nome="{{ cliente.nome }}"
                            data-indirizzo="{{ cliente.indirizzo or '' }}"
                            data-note="{{ cliente.note or '' }}"
                            data-stato="{{ cliente.stato }}">
                        ‚úèÔ∏è
                    </button>
                    
                    <form method="post" action="/clienti/{{ cliente.id }}/delete" style="display: inline;" onsubmit="return confirm('Eliminare questo cliente? ATTENZIONE: verranno eliminati anche tutti gli interventi, todo e pagamenti collegati!')">
                        <button type="submit" class="btn-icon btn-danger" title="Elimina cliente">
                            üóëÔ∏è
                        </button>
                    </form>
                </div>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert-info">
    <strong>Nessun cliente trovato</strong>
    {% if search %}
        con i filtri specificati: "<em>{{ search }}</em>" ({{ stato }})
    {% endif %}
</div>
{% endif %}

<!-- Note informative -->
<hr>
<details>
    <summary><strong>üìù Gestione Clienti</strong></summary>
    <div class="grid">
        <div>
            <h4>Funzioni Web</h4>
            <ul>
                <li>‚úÖ Visualizzazione lista clienti</li>
                <li>‚úÖ Ricerca e filtri</li>
                <li>‚úÖ Dettaglio cliente</li>
                <li>‚ùå Aggiunta/modifica (solo CLI)</li>
            </ul>
        </div>
        <div>
            <h4>Gestione via CLI</h4>
            <ul>
                <li><code>clienti client add</code> - Nuovo cliente</li>
                <li><code>clienti client edit "Nome"</code> - Modifica</li>
                <li><code>clienti client show "Nome"</code> - Dettagli</li>
                <li><code>clienti client list --help</code> - Opzioni</li>
            </ul>
        </div>
    </div>
    <p><small><em>Per operazioni CRUD complete utilizza l'interfaccia CLI</em></small></p>
</details>

<style>
.tag {
    background-color: var(--primary-color);
    color: white;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    margin-right: 0.25rem;
}

@media (max-width: 768px) {
    table {
        font-size: 0.75rem;
    }
    
    .table-responsive {
        overflow-x: scroll;
    }
    
    th:nth-child(3),
    td:nth-child(3),
    th:nth-child(4),
    td:nth-child(4),
    th:nth-child(6),
    td:nth-child(6) {
        display: none;
    }
}

/* Button styles from todos template */
.button-group-compact {
    display: flex;
    gap: 0.25rem;
    justify-content: center;
    align-items: center;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    border: 1px solid transparent;
    transition: all 0.2s ease;
    margin: 0;
    background: transparent;
    cursor: pointer;
    text-decoration: none;
}

.btn-icon:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.btn-info {
    color: #17a2b8;
    border-color: #17a2b8;
}

.btn-info:hover {
    background-color: #17a2b8;
    color: white;
}

.btn-primary {
    color: #007bff;
    border-color: #007bff;
}

.btn-primary:hover {
    background-color: #007bff;
    color: white;
}

.btn-danger {
    color: #dc3545;
    border-color: #dc3545;
}

.btn-danger:hover {
    background-color: #dc3545;
    color: white;
}
</style>

<!-- Edit Modal -->
<dialog id="edit-modal">
    <article style="width: 600px; max-width: 90vw;">
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('edit-modal').close()"></button>
            <h3>‚úèÔ∏è Modifica Cliente</h3>
        </header>
        
        <form id="edit-form" method="post" action="">
            <label for="edit_nome">Nome/Ragione Sociale *</label>
            <input type="text" name="nome" id="edit_nome" required>
            
            <label for="edit_indirizzo">Indirizzo</label>
            <input type="text" name="indirizzo" id="edit_indirizzo" placeholder="Via, numero, citt√†">
            
            <label for="edit_stato">Stato *</label>
            <select name="stato" id="edit_stato" required>
                <option value="attivo">üü¢ Attivo</option>
                <option value="prospect">üíº Prospect</option>
                <option value="pausa">‚è∏Ô∏è In pausa</option>
                <option value="archiviato">üìÅ Archiviato</option>
            </select>
            
            <label for="edit_note">Note</label>
            <textarea name="note" id="edit_note" rows="3" placeholder="Note interne sul cliente..."></textarea>
            
            <footer style="text-align: right; margin-top: 1rem;">
                <button type="button" class="secondary" onclick="document.getElementById('edit-modal').close()" style="margin-right: 0.5rem;">
                    Annulla
                </button>
                <button type="submit" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; color: white;">
                    üíæ Salva Modifiche
                </button>
            </footer>
        </form>
    </article>
</dialog>

<script>
// Edit cliente function
function editCliente(id, nome, indirizzo, note, stato) {
    // Set form action for the specific cliente
    document.getElementById('edit-form').action = `/clienti/${id}/edit`;
    
    // Set form values
    document.getElementById('edit_nome').value = nome;
    document.getElementById('edit_indirizzo').value = indirizzo;
    document.getElementById('edit_note').value = note;
    document.getElementById('edit_stato').value = stato;
    
    // Show modal
    document.getElementById('edit-modal').showModal();
}

// Handle edit buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const id = this.dataset.id;
            const nome = this.dataset.nome;
            const indirizzo = this.dataset.indirizzo;
            const note = this.dataset.note;
            const stato = this.dataset.stato;
            
            editCliente(id, nome, indirizzo, note, stato);
        });
    });
});
</script>

{% endblock %}