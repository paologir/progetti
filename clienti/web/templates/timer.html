{% extends "base.html" %}

{% block title %}Timer - Clienti CRM{% endblock %}

{% block content %}
<h1>‚è±Ô∏è Time Tracking</h1>

<!-- Timer attivo -->
{% if timer_attivo %}
<div class="timer-active">
    <h3>Timer Attivo</h3>
    <div class="timer-display" id="timer-status">
        <strong>{{ timer_attivo.cliente.nome }}</strong><br>
        {{ timer_attivo.descrizione }}<br>
        <span class="timer-display" id="timer-duration">Caricamento...</span><br>
        <small id="timer-compensation">Compenso: ‚Ç¨0.00</small>
    </div>
    <form method="post" action="/timer/stop" style="margin-top: 1rem;">
        <button type="submit" class="secondary" style="width: 100%;">‚èπÔ∏è Ferma Timer</button>
    </form>
</div>
{% else %}
<div class="alert-info">
    <strong>Nessun timer attivo</strong>
    <br>Avvia un nuovo timer per iniziare il tracking del tempo.
</div>
{% endif %}

<!-- Nuovo timer -->
{% if not timer_attivo %}
<h2>üöÄ Avvia Nuovo Timer</h2>

<form method="post" action="/timer/start">
    <div class="grid">
        <div>
            <label for="cliente_id">Cliente *</label>
            <select name="cliente_id" required>
                <option value="">Seleziona cliente...</option>
                {% for cliente in clienti %}
                <option value="{{ cliente.id }}">
                    {{ cliente.nome }} (‚Ç¨{{ cliente.tariffa_oraria|int }}/h)
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div>
            <label for="descrizione">Descrizione attivit√†</label>
            <input type="text" name="descrizione" placeholder="Es: Ottimizzazione campagne Google Ads">
        </div>
    </div>
    
    <button type="submit" style="width: 100%;">‚è±Ô∏è Avvia Timer</button>
</form>
{% endif %}

<!-- Sessioni recenti -->
<h2>üìä Sessioni Recenti ({{ sessioni_recenti|length }})</h2>

{% if sessioni_recenti %}
<div class="table-responsive">
    <table class="table-compact">
        <thead>
            <tr>
                <th>Data/Ora</th>
                <th>Cliente</th>
                <th>Descrizione</th>
                <th>Durata</th>
                <th>Tariffa</th>
                <th>Compenso</th>
                <th>Stato</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody>
        {% for sessione in sessioni_recenti %}
        <tr>
            <td>
                {{ sessione.inizio.strftime('%d/%m') }}<br>
                <small>{{ sessione.inizio.strftime('%H:%M') }} - {{ sessione.fine.strftime('%H:%M') }}</small>
            </td>
            <td>
                <strong><a href="/clienti/{{ sessione.cliente.id }}">{{ sessione.cliente.nome }}</a></strong>
            </td>
            <td>
                {{ sessione.descrizione or 'Lavoro' }}
                {% if sessione.note %}
                    <br><small style="color: #6c757d;">{{ sessione.note }}</small>
                {% endif %}
            </td>
            <td>
                <strong>{{ "%.1f"|format(sessione.durata_ore) }}h</strong><br>
                <small>{{ "%.0f"|format(sessione.durata_ore * 60) }}min</small>
            </td>
            <td>
                ‚Ç¨{{ sessione.tariffa_oraria|int }}/h
            </td>
            <td>
                <strong>‚Ç¨{{ "%.2f"|format(sessione.compenso) }}</strong>
            </td>
            <td>
                {% if sessione.fatturato %}
                    <span style="color: #28a745;">‚úÖ Fatturato</span>
                {% else %}
                    <span style="color: #ffc107;">‚è≥ Da fatturare</span>
                {% endif %}
            </td>
            <td>
                <div class="button-group-compact">
                    <button type="button" class="btn-icon btn-primary edit-session-btn" title="Modifica sessione"
                            data-id="{{ sessione.id }}"
                            data-cliente="{{ sessione.cliente.nome }}"
                            data-descrizione="{{ sessione.descrizione or '' }}"
                            data-tariffa="{{ sessione.tariffa_oraria }}"
                            data-note="{{ sessione.note or '' }}"
                            data-fatturato="{{ 'true' if sessione.fatturato else 'false' }}">
                        ‚úèÔ∏è
                    </button>
                    
                    <form method="post" action="/timer/{{ sessione.id }}/delete" style="display: inline;" onsubmit="return confirm('Eliminare questa sessione di lavoro? L\'azione √® irreversibile!')">
                        <button type="submit" class="btn-icon btn-danger" title="Elimina sessione">
                            üóëÔ∏è
                        </button>
                    </form>
                </div>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- Riassunto settimana -->
{% set ore_settimana = sessioni_recenti | map(attribute='durata_ore') | sum %}
{% set compenso_settimana = sessioni_recenti | map(attribute='compenso') | sum %}

<div class="alert-info" style="margin-top: 1rem;">
    <strong>üìà Riassunto ultimi 7 giorni:</strong>
    {{ sessioni_recenti|length }} sessioni, 
    {{ "%.1f"|format(ore_settimana) }}h lavorate, 
    ‚Ç¨{{ "%.2f"|format(compenso_settimana) }} di compensi
</div>

{% else %}
<p><em>Nessuna sessione di lavoro negli ultimi 7 giorni</em></p>
{% endif %}

<!-- Note informative -->
<hr>
<details>
    <summary><strong>üìù Gestione Time Tracking</strong></summary>
    <div class="grid">
        <div>
            <h4>Funzioni Web</h4>
            <ul>
                <li>‚úÖ Avvia/ferma timer</li>
                <li>‚úÖ Visualizzazione sessioni recenti</li>
                <li>‚úÖ Timer live con compenso</li>
                <li>‚úÖ Modifica/elimina sessioni</li>
            </ul>
        </div>
        <div>
            <h4>Funzioni CLI Complete</h4>
            <ul>
                <li><code>clienti time start "Cliente"</code></li>
                <li><code>clienti time stop</code></li>
                <li><code>clienti time list</code> - Lista sessioni con ID</li>
                <li><code>clienti time edit &lt;ID&gt;</code> - Modifica sessione</li>
                <li><code>clienti time delete &lt;ID&gt;</code> - Elimina sessione</li>
                <li><code>clienti time today</code> - Report giornaliero</li>
                <li><code>clienti time week</code> - Report settimanale</li>
                <li><code>clienti time report --cliente "Nome"</code></li>
                <li><code>clienti time export --month 9</code></li>
            </ul>
        </div>
    </div>
    <p><small><em>Per gestione completa delle sessioni utilizza l'interfaccia CLI</em></small></p>
</details>

<!-- Button styles -->
<style>
.button-group-compact {
    display: flex;
    gap: 0.25rem;
    justify-content: center;
    align-items: center;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    border: 1px solid transparent;
    transition: all 0.2s ease;
    margin: 0;
    background: transparent;
    cursor: pointer;
    text-decoration: none;
}

.btn-icon:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.btn-primary {
    color: #007bff;
    border-color: #007bff;
}

.btn-primary:hover {
    background-color: #007bff;
    color: white;
}

.btn-danger {
    color: #dc3545;
    border-color: #dc3545;
}

.btn-danger:hover {
    background-color: #dc3545;
    color: white;
}
</style>

<!-- Edit Session Modal -->
<dialog id="edit-session-modal">
    <article style="width: 600px; max-width: 90vw;">
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('edit-session-modal').close()"></button>
            <h3>‚úèÔ∏è Modifica Sessione di Lavoro</h3>
        </header>
        
        <form id="edit-session-form" method="post" action="">
            <div class="grid">
                <div>
                    <label>Cliente</label>
                    <input type="text" id="edit_cliente" readonly style="background: #f8f9fa; color: #6c757d;">
                </div>
                <div>
                    <label for="edit_tariffa">Tariffa oraria (‚Ç¨/h) *</label>
                    <input type="number" name="tariffa_oraria" id="edit_tariffa" step="0.50" min="0" required>
                </div>
            </div>
            
            <label for="edit_descrizione">Descrizione attivit√†</label>
            <input type="text" name="descrizione" id="edit_descrizione" placeholder="Es: Ottimizzazione campagne Google Ads">
            
            <div class="grid">
                <div>
                    <label for="edit_fatturato">Stato fatturazione</label>
                    <select name="fatturato" id="edit_fatturato" required>
                        <option value="false">‚è≥ Da fatturare</option>
                        <option value="true">‚úÖ Fatturato</option>
                    </select>
                </div>
                <div>
                    <label>Compenso Aggiornato</label>
                    <input type="text" id="edit_compenso" readonly style="background: #f8f9fa; color: #28a745; font-weight: bold;">
                </div>
            </div>
            
            <label for="edit_note">Note</label>
            <textarea name="note" id="edit_note" rows="3" placeholder="Note aggiuntive sulla sessione..."></textarea>
            
            <footer style="text-align: right; margin-top: 1rem;">
                <button type="button" class="secondary" onclick="document.getElementById('edit-session-modal').close()" style="margin-right: 0.5rem;">
                    Annulla
                </button>
                <button type="submit" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; color: white;">
                    üíæ Salva Modifiche
                </button>
            </footer>
        </form>
    </article>
</dialog>

{% endblock %}

{% block scripts %}
<script>
    // Timer live update
    function updateTimer() {
        const timerElement = document.getElementById('timer-status');
        if (!timerElement) return;
        
        fetch('/api/timer/status')
            .then(response => response.json())
            .then(data => {
                if (data.attivo) {
                    document.getElementById('timer-duration').textContent = `‚è±Ô∏è ${data.durata}`;
                    document.getElementById('timer-compensation').textContent = `Compenso: ‚Ç¨${data.compenso}`;
                }
            })
            .catch(error => {
                console.log('Timer update error:', error);
            });
    }
    
    // Update ogni secondo se timer √® attivo
    {% if timer_attivo %}
    setInterval(updateTimer, 1000);
    updateTimer(); // Prima chiamata immediata
    {% endif %}
    
    // Conferma stop timer
    document.querySelectorAll('form[action="/timer/stop"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            if (!confirm('Vuoi fermare il timer attivo?')) {
                e.preventDefault();
            }
        });
    });
    
    // Preview tariffa cliente
    const clienteSelect = document.querySelector('select[name="cliente_id"]');
    if (clienteSelect) {
        clienteSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const tariffaMatch = selectedOption.text.match(/‚Ç¨(\d+)\/h/);
                if (tariffaMatch) {
                    console.log(`Tariffa selezionata: ‚Ç¨${tariffaMatch[1]}/h`);
                }
            }
        });
    }
    
    // Edit session functionality
    let currentSessionData = {};
    
    function editSession(id, cliente, descrizione, tariffa, note, fatturato) {
        // Store current session data
        currentSessionData = {
            id, cliente, descrizione, tariffa, note, fatturato,
            durata_ore: parseFloat(document.querySelector(`button[data-id="${id}"]`).closest('tr').querySelector('td:nth-child(4) strong').textContent.replace('h', ''))
        };
        
        // Set form action for the specific session
        document.getElementById('edit-session-form').action = `/timer/${id}/edit`;
        
        // Set form values
        document.getElementById('edit_cliente').value = cliente;
        document.getElementById('edit_descrizione').value = descrizione;
        document.getElementById('edit_tariffa').value = tariffa;
        document.getElementById('edit_note').value = note;
        document.getElementById('edit_fatturato').value = fatturato;
        
        // Calculate and show initial compensation
        updateCompensation();
        
        // Show modal
        document.getElementById('edit-session-modal').showModal();
    }
    
    function updateCompensation() {
        const tariffa = parseFloat(document.getElementById('edit_tariffa').value) || 0;
        const durata = currentSessionData.durata_ore || 0;
        const compenso = tariffa * durata;
        document.getElementById('edit_compenso').value = `‚Ç¨${compenso.toFixed(2)}`;
    }
    
    // Handle edit buttons
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners for edit buttons
        document.querySelectorAll('.edit-session-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const id = this.dataset.id;
                const cliente = this.dataset.cliente;
                const descrizione = this.dataset.descrizione;
                const tariffa = this.dataset.tariffa;
                const note = this.dataset.note;
                const fatturato = this.dataset.fatturato;
                
                editSession(id, cliente, descrizione, tariffa, note, fatturato);
            });
        });
        
        // Update compensation when tariffa changes
        document.getElementById('edit_tariffa').addEventListener('input', updateCompensation);
    });
</script>
{% endblock %}